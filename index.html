<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小车对战游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#EC4899',
                        track: '#1F2937',
                        grass: '#10B981',
                        road: '#4B5563',
                    },
                    fontFamily: {
                        game: ['"Press Start 2P"', 'cursive', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-corners {
                clip-path: polygon(
                    0% 4px, 4px 4px, 4px 0%, calc(100% - 4px) 0%, calc(100% - 4px) 4px, 
                    100% 4px, 100% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), 
                    calc(100% - 4px) 100%, 4px 100%, 4px calc(100% - 4px), 0% calc(100% - 4px)
                );
            }
            .game-shadow {
                box-shadow: 0 0 0 2px #000, 8px 8px 0 #000;
            }
            .car-shadow {
                filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.5));
            }
            .animate-drive {
                animation: drive 0.5s infinite alternate;
            }
            @keyframes drive {
                from { transform: translateY(1px); }
                to { transform: translateY(-1px); }
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden">
    <!-- 游戏容器 -->
    <div class="relative w-full max-w-5xl flex flex-col items-center">
        <!-- 游戏标题 -->
        <h1 class="text-[clamp(1.5rem,5vw,2.5rem)] font-game text-primary mb-4 text-center tracking-wider">
            小车对战 <span class="text-secondary">BATTLE</span>
        </h1>
        
        <!-- 分数面板 -->
        <div class="w-full flex justify-between items-center mb-4 px-4 py-2 bg-gray-800 rounded-lg game-shadow">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-primary rounded-full mr-2 car-shadow"></div>
                <span class="font-game text-lg" id="player1-score">0</span>
            </div>
            <div class="font-game text-sm text-gray-400" id="game-status">准备开始!</div>
            <div class="flex items-center">
                <span class="font-game text-lg" id="player2-score">0</span>
                <div class="w-8 h-8 bg-secondary rounded-full ml-2 car-shadow"></div>
            </div>
        </div>
        
        <!-- 游戏画布容器 -->
        <div class="relative w-full aspect-[16/9] bg-grass rounded-lg overflow-hidden game-shadow">
            <!-- 赛道 -->
            <div class="absolute inset-4 bg-track rounded pixel-corners">
                <!-- 道路 -->
                <div class="absolute left-1/2 top-0 w-3/4 h-full -translate-x-1/2 bg-road rounded-md">
                    <!-- 道路中线 -->
                    <div class="absolute left-1/2 top-0 w-2 h-full -translate-x-1/2 bg-white/50" style="clip-path: polygon(0 0, 100% 15%, 100% 35%, 0 50%, 100% 65%, 100% 85%, 0 100%)"></div>
                </div>
                
                <!-- 障碍物 -->
                <div class="obstacle absolute w-12 h-12 bg-amber-500 rounded-md" style="left: 30%; top: 20%"></div>
                <div class="obstacle absolute w-12 h-12 bg-amber-500 rounded-md" style="left: 70%; top: 50%"></div>
                <div class="obstacle absolute w-12 h-12 bg-amber-500 rounded-md" style="left: 40%; top: 80%"></div>
                
                <!-- 玩家1的小车 -->
                <div id="player1" class="absolute w-12 h-8 bg-primary rounded-t-md car-shadow animate-drive" style="left: 25%; top: 80%">
                    <div class="absolute -left-2 top-1/2 w-3 h-1 bg-gray-800 -translate-y-1/2 rounded-full"></div>
                    <div class="absolute -right-2 top-1/2 w-3 h-1 bg-gray-800 -translate-y-1/2 rounded-full"></div>
                    <div class="absolute left-0 bottom-0 w-full h-1 bg-gray-800 rounded-b-md"></div>
                </div>
                
                <!-- 玩家2的小车 -->
                <div id="player2" class="absolute w-12 h-8 bg-secondary rounded-t-md car-shadow animate-drive" style="left: 75%; top: 20%">
                    <div class="absolute -left-2 top-1/2 w-3 h-1 bg-gray-800 -translate-y-1/2 rounded-full"></div>
                    <div class="absolute -right-2 top-1/2 w-3 h-1 bg-gray-800 -translate-y-1/2 rounded-full"></div>
                    <div class="absolute left-0 bottom-0 w-full h-1 bg-gray-800 rounded-b-md"></div>
                </div>
                
                <!-- 子弹容器 -->
                <div id="bullets-container"></div>
            </div>
            
            <!-- 游戏开始遮罩 -->
            <div id="start-screen" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-10">
                <h2 class="font-game text-2xl mb-8 text-center">按空格键开始</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full px-8">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-game text-primary text-lg mb-2">玩家 1</h3>
                        <ul class="text-sm space-y-2">
                            <li><span class="inline-block w-24">移动: </span><kbd class="px-2 py-1 bg-gray-700 rounded">W</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">S</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">A</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">D</kbd></li>
                            <li><span class="inline-block w-24">射击: </span><kbd class="px-2 py-1 bg-gray-700 rounded">Q</kbd></li>
                        </ul>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-game text-secondary text-lg mb-2">玩家 2</h3>
                        <ul class="text-sm space-y-2">
                            <li><span class="inline-block w-24">移动: </span><kbd class="px-2 py-1 bg-gray-700 rounded">↑</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">↓</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">←</kbd> <kbd class="px-2 py-1 bg-gray-700 rounded">→</kbd></li>
                            <li><span class="inline-block w-24">射击: </span><kbd class="px-2 py-1 bg-gray-700 rounded">Enter</kbd></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 游戏结束遮罩 -->
            <div id="end-screen" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-10 hidden">
                <h2 class="font-game text-2xl mb-4 text-center" id="winner-text">玩家 1 获胜!</h2>
                <p class="mb-6">按空格键重新开始</p>
                <button id="restart-button" class="bg-primary hover:bg-primary/80 font-game px-4 py-2 rounded transition-colors">
                    再来一局
                </button>
            </div>
        </div>
        
        <!-- 控制按钮（移动设备） -->
        <div class="mt-4 grid grid-cols-2 gap-4 w-full md:hidden">
            <div class="bg-gray-800 p-3 rounded-lg">
                <h3 class="text-primary font-bold mb-2 text-center">玩家 1 控制</h3>
                <div class="grid grid-cols-3 gap-1">
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="w">W</button>
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="a">A</button>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="s">S</button>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="d">D</button>
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-primary/70 rounded" data-key="q">射击</button>
                    <div></div>
                </div>
            </div>
            <div class="bg-gray-800 p-3 rounded-lg">
                <h3 class="text-secondary font-bold mb-2 text-center">玩家 2 控制</h3>
                <div class="grid grid-cols-3 gap-1">
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="arrowup">↑</button>
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="arrowleft">←</button>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="arrowdown">↓</button>
                    <button class="control-btn w-full aspect-square bg-gray-700 rounded" data-key="arrowright">→</button>
                    <div></div>
                    <button class="control-btn w-full aspect-square bg-secondary/70 rounded" data-key="enter">射击</button>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const game = {
            started: false,
            players: {
                1: {
                    element: document.getElementById('player1'),
                    x: 25,
                    y: 80,
                    width: 12,
                    height: 8,
                    speed: 3,
                    direction: 0, // 0-360度
                    isShooting: false,
                    lastShot: 0,
                    shootCooldown: 1000, // 1秒冷却
                    health: 100
                },
                2: {
                    element: document.getElementById('player2'),
                    x: 75,
                    y: 20,
                    width: 12,
                    height: 8,
                    speed: 3,
                    direction: 180, // 面向相反方向
                    isShooting: false,
                    lastShot: 0,
                    shootCooldown: 1000,
                    health: 100
                }
            },
            bullets: [],
            keys: {},
            scores: {
                1: 0,
                2: 0
            },
            canvas: {
                element: document.querySelector('.relative.w-full.aspect-\\[16\\/9\\]'),
                width: 0,
                height: 0
            },
            obstacles: document.querySelectorAll('.obstacle'),
            gameLoop: null,
            frameRate: 60,
            winner: null
        };

        // DOM 元素
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const winnerText = document.getElementById('winner-text');
        const restartButton = document.getElementById('restart-button');
        const gameStatus = document.getElementById('game-status');
        const player1Score = document.getElementById('player1-score');
        const player2Score = document.getElementById('player2-score');
        const bulletsContainer = document.getElementById('bullets-container');
        const controlButtons = document.querySelectorAll('.control-btn');

        // 初始化游戏尺寸
        function initGameSize() {
            const rect = game.canvas.element.getBoundingClientRect();
            game.canvas.width = rect.width;
            game.canvas.height = rect.height;
        }

        // 更新玩家位置
        function updatePlayerPosition(playerId) {
            const player = game.players[playerId];
            const speed = player.speed;
            
            // 根据方向计算移动向量
            const radians = player.direction * Math.PI / 180;
            let dx = Math.sin(radians) * speed;
            let dy = -Math.cos(radians) * speed; // 负号因为Y轴向下增加
            
            // 玩家1控制 (WASD)
            if (playerId === 1) {
                if (game.keys['w']) {
                    // 前进
                    player.x += dx;
                    player.y += dy;
                }
                if (game.keys['s']) {
                    // 后退
                    player.x -= dx;
                    player.y -= dy;
                }
                if (game.keys['a']) {
                    // 左转
                    player.direction = (player.direction - 5 + 360) % 360;
                }
                if (game.keys['d']) {
                    // 右转
                    player.direction = (player.direction + 5) % 360;
                }
                if (game.keys['q'] && Date.now() - player.lastShot > player.shootCooldown) {
                    shoot(playerId);
                    player.lastShot = Date.now();
                }
            }
            
            // 玩家2控制 (方向键)
            if (playerId === 2) {
                if (game.keys['arrowup']) {
                    // 前进
                    player.x += dx;
                    player.y += dy;
                }
                if (game.keys['arrowdown']) {
                    // 后退
                    player.x -= dx;
                    player.y -= dy;
                }
                if (game.keys['arrowleft']) {
                    // 左转
                    player.direction = (player.direction - 5 + 360) % 360;
                }
                if (game.keys['arrowright']) {
                    // 右转
                    player.direction = (player.direction + 5) % 360;
                }
                if (game.keys['enter'] && Date.now() - player.lastShot > player.shootCooldown) {
                    shoot(playerId);
                    player.lastShot = Date.now();
                }
            }
            
            // 边界检查 (赛道内部)
            const trackPadding = 4; // 赛道内边距
            const roadLeft = 25; // 道路左侧百分比
            const roadRight = 75; // 道路右侧百分比
            
            // 转换百分比到像素
            const trackWidth = game.canvas.width - trackPadding * 2;
            const trackHeight = game.canvas.height - trackPadding * 2;
            const minX = roadLeft / 100 * trackWidth + trackPadding;
            const maxX = roadRight / 100 * trackWidth + trackPadding;
            const minY = trackPadding;
            const maxY = trackHeight + trackPadding;
            
            // 限制在道路内
            player.x = Math.max(minX, Math.min(player.x, maxX));
            player.y = Math.max(minY, Math.min(player.y, maxY));
            
            // 更新DOM位置和旋转
            player.element.style.left = `${player.x}px`;
            player.element.style.top = `${player.y}px`;
            player.element.style.transform = `rotate(${player.direction}deg)`;
        }

        // 射击功能
        function shoot(playerId) {
            const player = game.players[playerId];
            const bullet = document.createElement('div');
            bullet.className = `absolute w-3 h-1 rounded-full ${playerId === 1 ? 'bg-primary' : 'bg-secondary'}`;
            
            // 计算子弹初始位置（从车前方射出）
            const radians = player.direction * Math.PI / 180;
            const bulletX = player.x + player.width/2 + Math.sin(radians) * player.height;
            const bulletY = player.y + player.height/2 - Math.cos(radians) * player.height;
            
            bullet.style.left = `${bulletX}px`;
            bullet.style.top = `${bulletY}px`;
            bullet.style.transform = `rotate(${player.direction}deg)`;
            
            bulletsContainer.appendChild(bullet);
            
            // 存储子弹信息
            game.bullets.push({
                element: bullet,
                x: bulletX,
                y: bulletY,
                direction: player.direction,
                speed: 8,
                owner: playerId
            });
            
            // 播放射击音效（这里用视觉反馈代替）
            const flash = document.createElement('div');
            flash.className = `absolute w-4 h-4 rounded-full bg-yellow-400 opacity-80`;
            flash.style.left = `${bulletX - 2}px`;
            flash.style.top = `${bulletY - 2}px`;
            bulletsContainer.appendChild(flash);
            
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 300);
            }, 100);
        }

        // 更新子弹位置
        function updateBullets() {
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const bullet = game.bullets[i];
                const radians = bullet.direction * Math.PI / 180;
                
                // 移动子弹
                bullet.x += Math.sin(radians) * bullet.speed;
                bullet.y -= Math.cos(radians) * bullet.speed;
                
                // 更新位置
                bullet.element.style.left = `${bullet.x}px`;
                bullet.element.style.top = `${bullet.y}px`;
                
                // 检查是否击中其他玩家
                const targetPlayerId = bullet.owner === 1 ? 2 : 1;
                const targetPlayer = game.players[targetPlayerId];
                
                // 简单碰撞检测
                if (
                    bullet.x > targetPlayer.x &&
                    bullet.x < targetPlayer.x + targetPlayer.width &&
                    bullet.y > targetPlayer.y &&
                    bullet.y < targetPlayer.y + targetPlayer.height
                ) {
                    // 击中目标
                    hitPlayer(targetPlayerId);
                    removeBullet(i);
                    continue;
                }
                
                // 检查是否击中障碍物
                let hitObstacle = false;
                game.obstacles.forEach(obstacle => {
                    const rect = obstacle.getBoundingClientRect();
                    const canvasRect = game.canvas.element.getBoundingClientRect();
                    
                    const obsX = rect.left - canvasRect.left;
                    const obsY = rect.top - canvasRect.top;
                    const obsWidth = rect.width;
                    const obsHeight = rect.height;
                    
                    if (
                        bullet.x > obsX &&
                        bullet.x < obsX + obsWidth &&
                        bullet.y > obsY &&
                        bullet.y < obsY + obsHeight
                    ) {
                        hitObstacle = true;
                    }
                });
                
                if (hitObstacle) {
                    removeBullet(i);
                    continue;
                }
                
                // 检查是否超出画布范围
                if (
                    bullet.x < 0 ||
                    bullet.x > game.canvas.width ||
                    bullet.y < 0 ||
                    bullet.y > game.canvas.height
                ) {
                    removeBullet(i);
                }
            }
        }

        // 移除子弹
        function removeBullet(index) {
            if (game.bullets[index].element) {
                game.bullets[index].element.remove();
            }
            game.bullets.splice(index, 1);
        }

        // 玩家被击中
        function hitPlayer(playerId) {
            const player = game.players[playerId];
            player.health -= 20;
            
            // 显示被击中效果
            player.element.classList.add('bg-red-500');
            setTimeout(() => {
                player.element.classList.remove('bg-red-500');
            }, 200);
            
            // 更新状态
            gameStatus.textContent = `玩家 ${playerId} 被击中!`;
            setTimeout(() => {
                gameStatus.textContent = '战斗中!';
            }, 1000);
            
            // 检查是否被击败
            if (player.health <= 0) {
                const winnerId = playerId === 1 ? 2 : 1;
                game.scores[winnerId]++;
                updateScores();
                endRound(winnerId);
            }
        }

        // 更新分数
        function updateScores() {
            player1Score.textContent = game.scores[1];
            player2Score.textContent = game.scores[2];
        }

        // 结束回合
        function endRound(winnerId) {
            game.started = false;
            clearInterval(game.gameLoop);
            
            game.winner = winnerId;
            winnerText.textContent = `玩家 ${winnerId} 获胜!`;
            endScreen.classList.remove('hidden');
            
            // 重置玩家位置和状态
            resetPlayers();
        }

        // 重置玩家
        function resetPlayers() {
            game.players[1] = {
                ...game.players[1],
                x: 25,
                y: 80,
                direction: 0,
                health: 100
            };
            
            game.players[2] = {
                ...game.players[2],
                x: 75,
                y: 20,
                direction: 180,
                health: 100
            };
            
            // 清除所有子弹
            game.bullets.forEach(bullet => bullet.element.remove());
            game.bullets = [];
            
            // 更新DOM
            updatePlayerPosition(1);
            updatePlayerPosition(2);
        }

        // 开始游戏
        function startGame() {
            if (game.started) return;
            
            game.started = true;
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameStatus.textContent = '战斗开始!';
            
            // 启动游戏循环
            const interval = 1000 / game.frameRate;
            game.gameLoop = setInterval(gameUpdate, interval);
        }

        // 游戏更新循环
        function gameUpdate() {
            updatePlayerPosition(1);
            updatePlayerPosition(2);
            updateBullets();
        }

        // 事件监听
        function setupEventListeners() {
            // 键盘控制
            window.addEventListener('keydown', (e) => {
                game.keys[e.key.toLowerCase()] = true;
                
                // 空格键开始游戏
                if (e.key === ' ' && (!game.started || game.winner)) {
                    startGame();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                game.keys[e.key.toLowerCase()] = false;
            });
            
            // 重启按钮
            restartButton.addEventListener('click', startGame);
            
            // 移动设备触摸控制
            controlButtons.forEach(button => {
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    game.keys[button.dataset.key] = true;
                });
                
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    game.keys[button.dataset.key] = false;
                });
                
                // 鼠标点击也支持
                button.addEventListener('mousedown', () => {
                    game.keys[button.dataset.key] = true;
                });
                
                button.addEventListener('mouseup', () => {
                    game.keys[button.dataset.key] = false;
                });
                
                button.addEventListener('mouseleave', () => {
                    game.keys[button.dataset.key] = false;
                });
            });
            
            // 窗口大小变化时重新计算
            window.addEventListener('resize', () => {
                initGameSize();
                // 重新定位玩家
                updatePlayerPosition(1);
                updatePlayerPosition(2);
            });
        }

        // 初始化游戏
        function init() {
            initGameSize();
            setupEventListeners();
            updatePlayerPosition(1);
            updatePlayerPosition(2);
        }

        // 启动游戏
        init();
    </script>
</body>
</html>